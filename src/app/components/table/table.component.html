<ng-container
  *elderLet="{
    fields: model.columns$ | async,
    mobile: layoutService.mobile$ | async,
    filter: filterService.filter$ | async
  } as state"
>
  <div #elderTable id="elderTable" class="drug-table--wrapper">
    <cdk-table
      matSort
      class="drug-table"
      [dataSource]="model"
      [fixedLayout]="true"
      [trackBy]="trackBy"
      role="treegrid"
      aria-label="Search Results"
      [keyObserver]
    >
      <!--Table headers-->
      <cdk-header-row
        class="row--header"
        *cdkHeaderRowDef="state.fields; sticky: true; index as i"
      ></cdk-header-row>

      <!--Group rows-->
      <cdk-row
        class="row--content"
        [class.is-expanded]="model.checkIsExpanded(row)"
        [class.is-group-row]="row.position.isGroup"
        *cdkRowDef="let row; columns: state.fields; when: rowShown(model)"
        (click)="model.toggle(row)"
        (keydown.Enter)="model.toggle(row); $event.preventDefault()"
        (keydown.Space)="model.toggle(row); $event.preventDefault()"
        [rowDetail]="row"
        [rowDetailVisible]="model.checkIsExpanded(row)"
      ></cdk-row>

      <ng-template cdkNoDataRow>
        <div class="no-data-row">
          <elder-brand [showTitle]="false"></elder-brand>
        </div>
      </ng-template>

      <ng-container *ngFor="let field of state.fields; index as col" cdkColumnDef="{{ field }}">
        <ng-container *cdkHeaderCellDef>
          <cdk-header-cell
            class="header"
            mat-sort-header
            keyEmitter
            [keyColumn]="this.col"
            [keyRow]="0"
          >
            <div class="header-content">
              {{ field | splitcase | titlecase }}
            </div>
          </cdk-header-cell>
        </ng-container>
        <ng-container *cdkCellDef="let row; index as rowIndex">
          <ng-container *ngIf="row.position.isGroup; else rowTemplate">
            <elder-group-row
              keyEmitter
              [keyRow]="rowIndex + 1"
              [keyColumn]="0"
              *ngIf="col === 0"
              [class.is-expanded]="model.checkIsExpanded(row)"
              [attr.aria-level]="getNestingLevel(row) + 1"
              [style.--left-padding]="getNestingLevel(row)"
            >
              <group-field>{{ row.field | splitcase }}</group-field>
              <group-name>{{ row.groupHeader | sentencecase }}</group-name>
            </elder-group-row>
          </ng-container>
          <ng-template #rowTemplate>
            <div
              role="gridcell"
              class="cell-container"
              [class.is-icon-cell]="col === 0"
              [style.--left-padding]="getNestingLevel(row)"
              keyEmitter
              [keyColumn]="col"
              [keyRow]="rowIndex + 1"
            >
              <button
                tabindex="-1"
                class="cell-chevron cdk-focus-hidden"
                aria-hidden="true"
                *ngIf="col === 0"
              >
                <svg
                  [class.is-rotated]="model.checkIsExpanded(row)"
                  class="cell-chevron-icon"
                  viewBox="0 0 24 24"
                >
                  <polygon points="8.1,3 6.9,4.1 14.8,12 6.9,19.9 8.1,21 17.1,12 8.1,3 " />
                </svg>
              </button>

              <div role="columnheader" class="cell-title">
                {{ field | splitcase | titlecase }}
              </div>
              <div
                role="gridcell"
                class="cell-content"
                [innerHtml]="
                  row.fields[field]
                    | toString
                    | sentencecase
                    | appendunit: getUnit(field)
                    | highlight: state.filter
                "
              ></div>
            </div>
          </ng-template>
        </ng-container>
      </ng-container>
      <!--Header Row-->
    </cdk-table>
  </div>
</ng-container>
