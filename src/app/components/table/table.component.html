<!--<elder-column-selector
  *ngIf="tableName"
  (columnUpdates)="(dataSource.displayedHeaders | async) = $event"
  [tableName]="tableName"
  (loaded)="selectorInitiated = true"
></elder-column-selector>-->

<div class="root soft-shadow-2" mobileListener>
  <h2><ng-content select="elder-table-title"></ng-content></h2>

  <h3><ng-content select="elder-table-description"></ng-content></h3>
  <mat-divider></mat-divider>
  <section class="table-fields">
    <div class="filter">
      <label class="filter__label"
        >Filter entries
        <div class="filter__input-wrapper">
          <input class="filter__input" (input)="filterData($event)" />
        </div>
      </label>
    </div>
    <elder-popup
      [selectedOptions]="columns.columnChangeObserver | async"
      #columnPopup
    >
      <popup-content>
        <elder-column-selector #columns></elder-column-selector
      ></popup-content>
    </elder-popup>
    <elder-popup
      [selectedOptions]="groups.groupChangeObserver | async"
      #groupPopup
    >
      <popup-content
        ><elder-group-by  #groups></elder-group-by
      ></popup-content>
    </elder-popup>
  </section>

  <cdk-table
    multiTemplateDataRows
    [dataSource]="dataSource"
    class="drug-table"
    matSort
    [fixedLayout]="true"
    mobileListener
    *ngIf="dataSource.displayedColumns | async as fields"
  >
    <cdk-header-row
      class="header-row"
      *cdkHeaderRowDef="fields; sticky: true"
      mobileListener
    ></cdk-header-row>
    <cdk-row
      *cdkRowDef="let row; columns: fields"
      class="row"
      (click)="dataSource.toggleExpansion(row)"
    ></cdk-row>
    <cdk-row *cdkRowDef="let row; columns: ['expandedDetail']"></cdk-row>
    <cdk-row
      *cdkRowDef="
        let row;
        columns: ['groupHeader'];
        when: dataSource.checkIsGroup
      "
      (click)="dataSource.toggleExpansion(row)"
    ></cdk-row>

    <ng-container
      *ngFor="let field of fields; trackBy: trackByFn"
      cdkColumnDef="{{ field }}"
    >
      <ng-container>
        <cdk-header-cell
          class="header-cell"
          mat-sort-header
          *cdkHeaderCellDef
          matTooltip="Sort by {{ field }}"
        >
          <div style="min-width: 0">
            <div class="header-cell__content">
              {{ field | caseSplit }}
            </div>
          </div>
        </cdk-header-cell>
      </ng-container>
      <ng-container>
        <cdk-cell #cell class="cell" *cdkCellDef="let row">
          <!--If the cell is first, add an expansion button to it-->
          <span class="cell__chevron-container">
            <button
              *ngIf="field === fields[0]"
              class="chevron-button"
              mat-icon-button
            >
              <mat-icon
                [class.--rotated]="dataSource.rowIsExpanded(row)"
                class="chevron-button__chevron"
                svgIcon="chevron_right"
              ></mat-icon></button
          ></span>
          <span role="columnheader" class="cell__mobile-header"
            ><b>{{ field }}</b></span
          >
          <span class="cell__content">{{ row[field] }}</span>
        </cdk-cell></ng-container
      >
    </ng-container>
    <ng-container cdkColumnDef="expandedDetail">
      <div *cdkCellDef="let row">
        <elder-expanded-element
          *ngIf="dataSource.rowIsExpanded(row)"
          [expansionData]="row"
        ></elder-expanded-element>
      </div>
    </ng-container>

    <ng-container cdkColumnDef="groupHeader">
      <cdk-header-cell
        *cdkCellDef="let row"
        class="expand-row__cell"
        [class.--open]="dataSource.rowIsExpanded(row)"
      >
        <span class="l-flex v-center-items">
          <mat-icon
            class="chevron"
            svgIcon="chevron_right"
            rotateIcon
            [class.--rotated]="dataSource.rowIsExpanded(row)"
          ></mat-icon>

          <span class="expand-row__cell__content">
            {{ groupProperty | caseSplit }}: {{ row.term | titlecase }}</span
          >
        </span>
      </cdk-header-cell>
    </ng-container>

    <!-- <ng-container cdkColumnDef="mobileColumns">
      <td
        class="mobile-row l-grid"
        cdk-cell
        *cdkCellDef="let row"
        [attr.colspan]="columnSpan"
      >
        <button
          class="mobile-row__expand-button grid__cell--span-1"
          mat-icon-button
        >
          <mat-icon
            [@rotateChevron]="row == expandedElement ? 'expanded' : 'collapsed'"
            class="mobile-row__expand-button__chevron"
            style="will-change: transform"
            svgIcon="chevron_right"
          ></mat-icon>
        </button>
        <div class="l-grid grid-spacing grid__cell--span-11">
          <ng-container
            class="mobile-cell"
            *ngFor="let field of dataSource.displayedHeaders | async"
          >
            <span class="mobile-cell__title grid__cell--span-4"
              ><b>{{ field | caseSplit }}</b></span
            >
            <span class="mobile-cell__content grid__cell--span-8">{{
              row[field]
            }}</span>
          </ng-container>
        </div>
      </td>
    </ng-container>-->
  </cdk-table>
</div>
