<form [formGroup]="drugsGroup">
  <section
    cdkScrollable
    aria-label="You can look up drugs on Beers Criteria using this form"
    class="form-container"
  >
    <div fxLayout="column" fxLayoutAlign="center center">
      <label
        class="add-drug-field add-drug-field__label"
        [class.flatbottom]="autocomplete.isOpen"
        (click)="addDrugField?.focus()"
        [class.lifted]="drugInput.dirty"
      >
        ADD DRUGS
        <div
          #addDrugOrigin="matAutocompleteOrigin"
          matAutocompleteOrigin
          class="add-drug-field__container"
          [class.is-missing]="drugInput.errors?.invalidAsync"
          [class.is-invalid]="drugInput.invalid && drugInput.value.length"
          [class.mat-elevation-z4]="addDrugTrigger.panelOpen"
          [class.is-open]="addDrugTrigger.panelOpen"
          id="add-drug-field"
        >
          <input
            type="text"
            formControlName="drugInput"
            (keydown.Enter)="addDrugTrigger?.closePanel()"
            (input)="filterAutocomplete(addDrugField.value)"
            class="add-drug-field__input"
            aria-label="Enter your drug name here. For example, 'zolpidem'"
            #addDrugField
            #addDrugTrigger="matAutocompleteTrigger"
            [matAutocomplete]="autocompleteRef"
            [matAutocompleteConnectedTo]="addDrugOrigin"
            placeholder="Zolpidem"
            aria-describedby="errors"
          />
          <div
            class="add-drug-field__spinner-container"
            *ngIf="drugInput.pending; else addButton"
          >
            <mat-spinner diameter="25"></mat-spinner>
          </div>

          <ng-template #addButton>
            <button
              [disabled]="!drugInput.valid"
              mat-icon-button
              class="add-button"
              [matTooltip]="
                drugInput.valid
                  ? 'Add ' + addDrugField?.value
                  : 'Choose a drug from the dropdown'
              "
              matTooltipPosition="above"
              matTooltipShowDelay="200"
              matTooltipHideDelay="200"
              matTooltipClass="add-drug-field__tooltip add-drug-field__tooltip--arrow-tip"
              (click)="
                addInput(); addDrugTrigger.closePanel(); (stopPropagation)
              "
            >
              <mat-icon
                class="add-button__add-icon"
                inline="true"
                svgIcon="add--outline"
              ></mat-icon></button
          ></ng-template>
        </div>
      </label>
      <div
        *ngIf="drugInput.invalid && !drugInput.hasError('required')"
        class="add-drug-field__errors errors"
        id="errors"
        [class.is-invalid]="drugInput.invalid"
        [class.is-missing]="drugInput.errors?.invalidAsync"
      >
        <div>
          <mat-icon
            [svgIcon]="drugInput.errors?.invalidAsync ? 'warn' : 'error'"
          ></mat-icon>
        </div>
        <div>
          <span role="alert" *ngIf="drugInput.errors?.minlength">
            Drug names must be at least 3 characters long.
          </span>
          <span role="alert" *ngIf="drugInput.errors?.maxLength">
            Drug names should be fewer than 70 characters.
          </span>
          <span role="alert" *ngIf="drugInput.errors?.pattern">
            Drug names should only contain alphanumeric letters.
          </span>
          <span role="alert" *ngIf="drugInput.errors?.invalidAsync"
            >Only drugs from the dropdown menu have guidance.
          </span>
        </div>
      </div>

      <div class="chip-list--container">
        <mat-list
          formArrayName="drugList"
          #chipList
          aria-label="Drug selection"
        >
          <div mat-subheader class="chip-list__title">SEARCH TERMS</div>

          <mat-list-item
            *ngFor="let drugName of drugList.controls; index as i"
            tabIndex="-1"
            #searchList
          >
            <mat-icon
              mat-list-icon
              matTooltip="Remove {{ drugName.value }}"
              matTooltipPosition="below"
              matTooltipShowDelay="200"
              matTooltipClass="tooltip"
              (mouseover)="matTooltip.disabled = true"
              (mouseleave)="matTooltip.disabled = false"
              svgIcon="cancel"
              tabIndex="0"
              class="remove-icon"
              (click)="
                removeOptionAt(i);
                addDrugTrigger.closePanel();
                (stopPropagation)
              "
              (keydown.enter)="removeOptionAt(i)"
            ></mat-icon>
            <span
              #drugEditOrigin="matAutocompleteOrigin"
              matAutocompleteOrigin
              class="edit-drug-field"
              ><input
                class="edit-drug-field__input"
                (keydown.enter)="editDrugField.blur()"
                (change)="log(getControlAt(i))"
                (input)="filterAutocomplete(editDrugField.value)"
                #editDrugField
                #editDrugTrigger="matAutocompleteTrigger"
                [formControlName]="i"
                [matAutocomplete]="autocompleteRef"
                [matAutocompleteConnectedTo]="drugEditOrigin"
                matTooltip="Click to edit {{ drugName.value }}"
                matTooltipPosition="below"
                matTooltipShowDelay="200"
                matTooltipHideDelay="200"
                #matTooltip="matTooltip"
                matTooltipClass="tooltip"
                [class.is-missing]="getControlAt(i).errors?.invalidAsync"
              />
            </span>

            <mat-divider *ngIf="i != drugListLength - 1"></mat-divider>
          </mat-list-item>
        </mat-list>
        <mat-autocomplete
          #autocomplete
          autoActiveFirstOption
          #autocompleteRef="matAutocomplete"
          class="drug-form-autocomplete"
          @fadeAutocomplete
        >
          <mat-option
            #displayOption
            [value]="option[0] + option[1]"
            *ngFor="let option of autocompleteObserver | async"
            (keydown.enter)="chooseOption(displayOption.value)"
          >
            <span>
              <span style="font-weight: 500">{{ option[0] }}</span
              >{{ option[1] }}</span
            >
            <span *ngIf="addDrugTrigger.panelOpen">
              <ng-container [ngSwitch]="option[2]">
                <span class="chip chip--generic" *ngSwitchCase="'~g'"
                  >generic</span
                >
                <span class="chip chip--brand" *ngSwitchCase="'~b'">brand</span>
              </ng-container></span
            >
          </mat-option>
        </mat-autocomplete>
      </div>
    </div>
  </section>
</form>

<!--<button
            mat-icon-button
            (click)="removeOptionAt(i); trigger.closePanel(); stopPropagation()"
            (keydown.enter)="removeOptionAt(i)"
            *ngIf="i > 0"
          >
            <mat-icon
              class="remove icon-button"
              inline="true"
              svgIcon="delete"
            ></mat-icon>
          </button>-->
