<ng-container
  *elderLet="{
    mobile: mobile$ | async,
    searchInProgress: searchInProgress$ | async,
    typeahead: typeaheadState$ | async
  } as state"
>
  <form
    #drugform
    (ngSubmit)="$event.preventDefault(); search($event)"
    [formGroup]="drugsGroup"
  >
    <section
      aria-label="You can look up drugs on Beers Criteria using this form"
      class="form-container"
      [class.is-widened]="state.searchInProgress"
    >
      <div
        cdkMonitorSubtreeFocus
        (cdkFocusChange)="setFocusStatus($event, -1)"
        class="search-field"
      >
        <div
          #autoOrigin="matAutocompleteOrigin"
          matAutocompleteOrigin
          class="search-field__input-container"
          [class.is-missing]="drugInput.errors?.invalidAsync"
          [class.is-invalid]="drugInput.invalid && drugInput.value.length"
          [class.is-pinned]="state.searchInProgress"
          [class.is-open]="drugInput.value.length"
          name="search"
        >
          <button
            mat-icon-button
            class="add-button"
            [disabled]="drugList.length === 0"
            [matTooltip]="getTooltipText('search')"
            matTooltipPosition="above"
            (click)="$event.preventDefault()"
            matTooltipClass="search-field__tooltip search-field__tooltip--arrow-tip"
          >
            <mat-icon
              class="icon-button__icon smaller"
              inline="true"
              svgIcon="search"
            ></mat-icon>
          </button>
          <input
            type="text"
            title="Search"
            formControlName="drugInput"
            attr.data-control="-1"
            class="search-field__input"
            placeholder="Zolpidem"
            aria-label="Enter a drug name. For example, 'zolpidem'"
            aria-describedby="errors"
            #searchInput
            #searchInputAutoTrigger="matAutocompleteTrigger"
            [matAutocomplete]="autocomplete"
            [matAutocompleteConnectedTo]="autoOrigin"
            (keydown.Enter)="searchInput.value.length || search($event)"
          />
          <div
            class="search-field__spinner-container"
            *ngIf="state.typeahead.pending; else addButton"
          >
            <mat-spinner diameter="25"></mat-spinner>
          </div>

          <ng-template #addButton>
            <button
              mat-icon-button
              class="icon-button"
              (click)="addTerm(); searchInput.focus(); $event.preventDefault()"
              [disabled]="!drugInput.valid || !drugList.valid"
              [matTooltip]="getTooltipText('add')"
              matTooltipPosition="above"
              matTooltipClass="search-field__tooltip search-field__tooltip--arrow-tip"
            >
              <mat-icon
                class="icon-button__icon"
                inline="true"
                svgIcon="add-2"
              ></mat-icon></button
          ></ng-template>
        </div>
        <div class="search-field__errors" id="errors">
          <elder-error-message
            [@transitionMessages]="'enter'"
            *ngIf="
              (drugInput.errors || drugList.errors) &&
              drugInput.value.length > 0
            "
            [error-messages]="this.errorMessages"
            [warning-messages]="this.warningMessages"
            [errors]="this.drugInput.errors"
          ></elder-error-message>
        </div>
      </div>

      <section
        class="wrapper__edit-list section--constrained-width section--centered"
        [@shiftEditList]="
          (drugInput.errors || drugList.errors) && drugInput.value.length > 0
            ? 'shift'
            : 'unshift'
        "
      >
        <mat-list
          formArrayName="drugList"
          #chipList
          aria-label="Drug selection"
          class="edit__list"
          [class.not-shifted]="
            !(
              (drugInput.errors || drugList.errors) &&
              drugInput.value.length > 0
            )
          "
        >
          <div
            *ngIf="drugListLength > 0"
            mat-subheader
            class="edit__list__title"
          >
            SELECTED DRUGS
          </div>

          <div
            class="edit__item-wrapper"
            [class.list-shown]="drugList.length > 0"
          >
            <mat-list-item
              *ngFor="let drugName of drugList.controls; index as i"
              #searchList
              class="edit__list__item edit-item"
              cdkMonitorSubtreeFocus
              (cdkFocusChange)="setFocusStatus($event, i)"
            >
              <mat-icon
                mat-list-icon
                matTooltip="Remove {{ drugName.value }}"
                matTooltipPosition="below"
                matTooltipShowDelay="200"
                matTooltipClass="tooltip"
                svgIcon="cancel"
                tabIndex="0"
                class="edit-item__icon"
                (mouseover)="editDrugTooltip.disabled = true"
                (mouseleave)="editDrugTooltip.disabled = false"
                (click)="
                  deleteListControl(i); searchInputAutoTrigger.closePanel()
                "
                (keydown.enter)="deleteListControl(i)"
              ></mat-icon>
              <span
                #editOrigin="matAutocompleteOrigin"
                matAutocompleteOrigin
                class="edit-item__field"
                ><input
                  class="edit-item__field__input"
                  (keydown.enter)="editDrugField.blur()"
                  (blur)="editDrugField.value.length || deleteListControl(i)"
                  (focusin)="editDrugTooltip.disabled = true"
                  (focusout)="editDrugTooltip.disabled = false"
                  [class.is-missing]="getListControl(i).errors?.invalidAsync"
                  [formControlName]="i"
                  [matAutocomplete]="autocomplete"
                  [matAutocompleteConnectedTo]="editOrigin"
                  attr.data-control="{{ i }}"
                  #editDrugField
                  #editDrugAutoTrigger="matAutocompleteTrigger"
                  #editDrugTooltip="matTooltip"
                  matTooltip="Click to edit {{ drugName.value }}"
                  matTooltipPosition="below"
                  matTooltipClass="tooltip"
                />
              </span>

              <mat-divider
                class="edit-item__divider"
                *ngIf="i != drugListLength - 1"
              ></mat-divider>
            </mat-list-item>
          </div>
        </mat-list>
        <mat-autocomplete
          #autocomplete
          autoActiveFirstOption
          class="typeahead"
          (optionSelected)="chooseTerm($event)"
          (opened)="updateActiveTrigger()"
          (closed)="updateActiveTrigger()"
        >
          <div class="typeahead__options">
            <mat-option
              [value]="option[0] + option[1]"
              *ngFor="let option of state.typeahead.data | slice: 0:10"
              [class.is-editing]="false"
              [class.is-full]="true"
            >
              <div class="option__content">
                <mat-icon class="option__icon" svgIcon="search"></mat-icon>
                <span>
                  <span style="font-weight: 500">{{ option[0] }}</span
                  >{{ option[1] }}
                </span>
                <ng-container
                  *ngIf="searchInputAutoTrigger.panelOpen"
                  [ngSwitch]="option[2]"
                >
                  <div class="chip chip--generic" *ngSwitchCase="'~g'">
                    generic
                  </div>
                  <div class="chip chip--brand" *ngSwitchCase="'~b'">brand</div>
                </ng-container>
              </div>
            </mat-option>
          </div>
          <ng-template
            #portalOutlet="cdkPortalOutlet"
            [cdkPortalOutlet]="
              (mobile$ | async) && searchInputAutoTrigger.panelOpen
                ? buttonPortal
                : undefined
            "
          ></ng-template>
        </mat-autocomplete>
      </section>
    </section>
  </form>
</ng-container>
