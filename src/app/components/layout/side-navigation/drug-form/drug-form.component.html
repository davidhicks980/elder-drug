<ng-container
  *elderLet="{
    pinSearch: pinSearch$ | async,
    typeahead: typeaheadState$ | async,
    mobile: layoutService.mobile$ | async
  } as state"
>
  <form #drugform (ngSubmit)="search($event)" [formGroup]="drugsGroup">
    <section
      aria-label="Add and search multiple drugs on beers criteria"
      class="form-container"
      [class.is-widened]="state.pinSearch"
    >
      <div
        class="search-container"
        cdkMonitorSubtreeFocus
        (cdkFocusChange)="setFocusStatus($event, -1)"
      >
        <label class="search-label" for="searchinput">Add drugs</label>
        <div
          class="search-field"
          #autoOrigin="matAutocompleteOrigin"
          matAutocompleteOrigin
          [class.is-missing]="drugInput.errors?.termabsent"
          [class.is-invalid]="drugInput.invalid && drugInput.value.length"
          [class.is-pinned]="state.pinSearch"
          [class.is-dirty]="!drugInputIsEmpty"
          [class.is-open]="searchInputAutoTrigger.panelOpen"
        >
          <button
            *ngIf="!state.pinSearch || !state.mobile; else toggle"
            (click)="search()"
            [matTooltip]="drugListLength > 0 ? 'Search drugs' : 'Add drugs to search'"
            matTooltipPosition="above"
            matRipple
            [matRippleRadius]="20"
            [matRippleCentered]="true"
            [matRippleUnbounded]="true"
            class="search-icon"
          >
            <mat-icon
              data-search-icon
              class="icon-button__icon smaller"
              inline="true"
              svgIcon="search"
            ></mat-icon>
          </button>
          <ng-template #toggle>
            <elder-menu-toggle (toggle)="unpinSearch()" [toggled]="true">
              <elder-animated-arrow toggle-icon></elder-animated-arrow> </elder-menu-toggle
          ></ng-template>

          <input
            class="search-input"
            type="text"
            title="Search"
            id="searchinput"
            formControlName="drugInput"
            placeholder="Zolpidem"
            aria-label="Enter a drug name. For example, 'zolpidem'"
            aria-describedby="errors"
            #searchInput
            #searchInputAutoTrigger="matAutocompleteTrigger"
            [matAutocomplete]="autocomplete"
            [matAutocompleteConnectedTo]="autoOrigin"
            [matAutocompleteDisabled]="state.typeahead.length === 0"
            (keydown.enter)="searchInput.value.length || search($event)"
          />
          <div class="search-spinner-container" *ngIf="state.typeahead.pending; else addButton">
            <mat-spinner diameter="25"></mat-spinner>
          </div>
          <ng-template #addButton>
            <button
              (click)="addListControl(); searchInput.focus(); $event.preventDefault()"
              matTooltip="Add drugs"
              matTooltipPosition="above"
              matTooltipClass="search-field__tooltip search-field__tooltip--arrow-tip"
              matRipple
              [matRippleRadius]="20"
              [matRippleCentered]="true"
              [matRippleUnbounded]="true"
              [disabled]="!drugInput.valid || !drugList.valid"
              class="search-icon"
            >
              <mat-icon data-add-icon inline="true" svgIcon="add-2"></mat-icon>
            </button>
          </ng-template>
        </div>
        <elder-error-message
          [errorMessages]="errorMessages"
          [warningMessages]="warningMessages"
          [errors]="drugInput.errors"
        ></elder-error-message>
      </div>

      <section
        class="edit-section"
        [class.is-pinned]="state.pinSearch"
        [@shiftEditList]="
          (drugInput.errors || drugList.errors) && !drugInputIsEmpty && !state.pinSearch
            ? 'shift'
            : 'unshift'
        "
      >
        <ul
          class="edit-list"
          #chipList
          formArrayName="drugList"
          aria-label="Drug selection"
          [class.not-shifted]="!((drugInput.errors || drugList.errors) && !drugInputIsEmpty)"
          *ngIf="!drugListIsEmpty"
        >
          <h2 class="edit-title">Selected Drugs</h2>

          <li
            *ngFor="let drugName of drugList.controls; index as index"
            class="edit-item"
            cdkMonitorSubtreeFocus
            (cdkFocusChange)="setFocusStatus($event, index)"
          >
            <div
              class="edit-item-content"
              #editOrigin="matAutocompleteOrigin"
              matAutocompleteOrigin
              [class.is-missing]="getListControl(index).errors?.invalidAsync"
              [class.is-invalid]="getListControl(index)?.errors"
              [class.has-attached]="editDrugAutoTrigger.panelOpen"
            >
              <button
                mat-icon-button
                class="edit-list-button"
                (click)="deleteListControl(index); searchInputAutoTrigger.closePanel()"
                matTooltip="Remove {{ drugName.value }}"
                matTooltipPosition="below"
                matTooltipClass="tooltip"
                matTooltipShowDelay="1000"
                (mouseover)="editDrugTooltip.disabled = true"
                (mouseleave)="editDrugTooltip.disabled = false"
              >
                <mat-icon svgIcon="x-delete" class="edit-icon"></mat-icon>
              </button>
              <input
                class="edit-input"
                #editDrugField
                #editDrugAutoTrigger="matAutocompleteTrigger"
                #editDrugTooltip="matTooltip"
                (keydown.enter)="$event.preventDefault(); editDrugField.blur()"
                (blur)="editDrugField.value.length || deleteListControl(index)"
                (focusin)="editDrugTooltip.disabled = true"
                (focusout)="editDrugTooltip.disabled = false"
                [formControlName]="index"
                [matAutocomplete]="autocomplete"
                [matAutocompleteConnectedTo]="editOrigin"
                [matAutocompleteDisabled]="state.typeahead.length === 0"
                matTooltip="Edit {{ drugName.value }}"
                matTooltipPosition="below"
                matTooltipClass="tooltip"
                matTooltipShowDelay="1000"
              />
              <button
                class="edit-list-button"
                (click)="editDrugField.focus(); $event.preventDefault()"
                mat-icon-button
              >
                <mat-icon svgIcon="edit"></mat-icon>
              </button>
            </div>
            <elder-error-message
              *ngIf="getListControl(index)?.errors"
              [errorMessages]="this.errorMessages"
              [warningMessages]="this.warningMessages"
              [errors]="getListControl(index)?.errors"
            ></elder-error-message>
          </li>
        </ul>
        <mat-autocomplete
          class="typeahead"
          #autocomplete
          autoActiveFirstOption
          (optionSelected)="chooseTerm($event)"
        >
          <div class="typeahead__options">
            <mat-option
              [value]="option[0] + option[1]"
              [title]="option[0] + option[1]"
              [class.is-pinned]="state.pinSearch"
              *ngFor="let option of state.typeahead.data | slice: 0:10"
            >
              <autocomplete-content
                [hideChips]="!searchInputAutoTrigger.panelOpen"
                [type]="option[2]"
              >
                <matched-content>{{ option[0] }}</matched-content>
                <inferred-content>{{ option[1] }}</inferred-content>
              </autocomplete-content>
            </mat-option>
          </div>
        </mat-autocomplete>
      </section>
    </section>
  </form>
</ng-container>
