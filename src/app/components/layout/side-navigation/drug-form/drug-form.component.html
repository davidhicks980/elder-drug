<ng-container
  *elderLet="{
    searchInProgress: searchInProgress$ | async,
    typeahead: typeaheadState$ | async
  } as state"
>
  <form #drugform (ngSubmit)="search($event)" [formGroup]="drugsGroup">
    <section
      aria-label="Add and search multiple drugs on beers criteria"
      class="form-container"
      [class.is-widened]="state.searchInProgress"
    >
      <div
        class="search-container"
        cdkMonitorSubtreeFocus
        (cdkFocusChange)="setFocusStatus($event, -1)"
      >
        <label style="margin: 5px" for="searchinput">Add drugs to search</label>
        <div
          class="search-field"
          #autoOrigin="matAutocompleteOrigin"
          matAutocompleteOrigin
          [class.is-missing]="drugInput.errors?.invalidAsync"
          [class.is-invalid]="drugInput.invalid && drugInput.value.length"
          [class.is-pinned]="state.searchInProgress"
          [class.is-dirty]="!drugInputIsEmpty"
          [class.is-open]="searchInputAutoTrigger.panelOpen"
        >
          <button
            mat-icon-button
            (click)="$event.preventDefault()"
            [disabled]="drugInputIsEmpty"
            [matTooltip]="getTooltipText('search')"
            matTooltipPosition="above"
          >
            <mat-icon
              data-search-icon
              class="icon-button__icon smaller"
              inline="true"
              svgIcon="search"
            ></mat-icon>
          </button>
          <input
            class="search-input"
            type="text"
            title="Search"
            id="searchinput"
            formControlName="drugInput"
            placeholder="Zolpidem"
            aria-label="Enter a drug name. For example, 'zolpidem'"
            aria-describedby="errors"
            #searchInput
            #searchInputAutoTrigger="matAutocompleteTrigger"
            [matAutocomplete]="autocomplete"
            [matAutocompleteConnectedTo]="autoOrigin"
            (keydown.Enter)="searchInput.value.length || search($event)"
          />
          <div class="search-spinner-container" *ngIf="state.typeahead.pending; else addButton">
            <mat-spinner diameter="25"></mat-spinner>
          </div>

          <ng-template #addButton>
            <button
              mat-icon-button
              class="icon-button"
              (click)="addTerm(); searchInput.focus(); $event.preventDefault()"
              [disabled]="!drugInput.valid || !drugList.valid"
              [matTooltip]="getTooltipText('add')"
              matTooltipPosition="above"
              matTooltipClass="search-field__tooltip search-field__tooltip--arrow-tip"
            >
              <mat-icon data-add-icon inline="true" svgIcon="add-2"></mat-icon></button
          ></ng-template>
        </div>
        <elder-error-message
          [@transitionMessages]="'enter'"
          [error-messages]="this.errorMessages"
          [warning-messages]="this.warningMessages"
          [errors]="this.drugInput.errors"
        ></elder-error-message>
      </div>

      <section
        class="wrapper__edit-list section--constrained-width section--centered"
        [@shiftEditList]="
          (drugInput.errors || drugList.errors) && !drugInputIsEmpty ? 'shift' : 'unshift'
        "
      >
        <mat-list
          formArrayName="drugList"
          #chipList
          aria-label="Drug selection"
          class="edit-list"
          [class.not-shifted]="!((drugInput.errors || drugList.errors) && !drugInputIsEmpty)"
        >
          <div *ngIf="!drugListIsEmpty" mat-subheader class="edit-title">SELECTED DRUGS</div>

          <div class="edit-items" [class.list-shown]="!drugListIsEmpty">
            <mat-list-item
              *ngFor="let drugName of drugList.controls; index as index"
              class="edit-item"
              cdkMonitorSubtreeFocus
              (cdkFocusChange)="setFocusStatus($event, index)"
            >
              <mat-icon
                mat-list-icon
                matTooltip="Remove {{ drugName.value }}"
                matTooltipPosition="below"
                matTooltipClass="tooltip"
                svgIcon="x"
                tabIndex="0"
                (mouseover)="editDrugTooltip.disabled = true"
                (mouseleave)="editDrugTooltip.disabled = false"
                (click)="deleteListControl(index); searchInputAutoTrigger.closePanel()"
                (keydown.enter)="deleteListControl(index)"
              ></mat-icon>
              <span #editOrigin="matAutocompleteOrigin" matAutocompleteOrigin class="edit-field"
                ><input
                  class="edit-input"
                  (keydown.enter)="editDrugField.blur()"
                  (blur)="editDrugField.value.length || deleteListControl(index)"
                  (focusin)="editDrugTooltip.disabled = true"
                  (focusout)="editDrugTooltip.disabled = false"
                  [class.is-missing]="getListControl(index).errors?.invalidAsync"
                  [formControlName]="index"
                  [matAutocomplete]="autocomplete"
                  [matAutocompleteConnectedTo]="editOrigin"
                  #editDrugField
                  #editDrugAutoTrigger="matAutocompleteTrigger"
                  #editDrugTooltip="matTooltip"
                  matTooltip="Edit {{ drugName.value }}"
                  matTooltipPosition="below"
                  matTooltipClass="tooltip"
                />
              </span>
            </mat-list-item>
          </div>
        </mat-list>
        <mat-autocomplete
          class="typeahead"
          #autocomplete
          autoActiveFirstOption
          (optionSelected)="chooseTerm($event)"
          (opened)="updateActiveTrigger()"
          (closed)="updateActiveTrigger()"
        >
          <div class="typeahead__options">
            <mat-option
              [value]="option[0] + option[1]"
              *ngFor="let option of state.typeahead.data | slice: 0:10"
              [class.is-editing]="false"
              [class.is-full]="true"
              [title]="option[0] + option[1]"
            >
              <autocomplete-content
                [showChips]="searchInputAutoTrigger.panelOpen"
                [type]="option[2]"
              >
                <matched-content>{{ option[0] }}</matched-content>
                <inferred-content>{{ option[1] }}</inferred-content>
              </autocomplete-content>
            </mat-option>
          </div>
        </mat-autocomplete>
      </section>
    </section>
    <section class="submit-button"><ng-content select="drug-form-submit"></ng-content></section>
  </form>
</ng-container>
