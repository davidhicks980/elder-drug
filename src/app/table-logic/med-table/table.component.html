<app-column-selector
  *ngIf="tableName"
  (columnUpdates)="fields = $event"
  [tableName]="tableName"
  (loaded)="selectorInitiated = true"
></app-column-selector>
<div class="table-container">
  <table
    *ngIf="loaded"
    cdk-table
    multiTemplateDataRows
    [dataSource]="dataSource"
    class="table"
    matSort
    [fixedLayout]="true"
    [class.isMobile]="true"
  >
    <ng-container *ngFor="let field of fields" cdkColumnDef="{{ field }}">
      <ng-container [ngSwitch]="field">
        <ng-container *ngSwitchCase="'expand'">
          <th
            cdk-header-cell
            class="header-cell"
            mat-sort-header
            *cdkHeaderCellDef
            style="width: 3.5em"
          ></th>
          <td cdk-cell class="table-cell" *cdkCellDef="let row">
            <button mat-icon-button>
              <mat-icon
                [@rotateChevron]="
                  row == expandedElement ? 'expanded' : 'collapsed'
                "
                class="chevron-button--rotate"
                style="will-change: transform"
                *ngIf="field === 'expand'"
                svgIcon="chevron_right"
              ></mat-icon>
            </button>
          </td>
        </ng-container>
        <ng-container *ngSwitchDefault>
          <th
            cdk-header-cell
            class="header-cell"
            mat-sort-header
            *cdkHeaderCellDef
            style="width: calc(100%)"
          >
            <div style="display: grid">
              <div style="min-width: 0">
                <div class="cell header-cell--text">
                  {{ field | caseSplit }}
                </div>
              </div>
            </div>
          </th>
          <td cdk-cell class="table-cell" *cdkCellDef="let row">
            <span class="cell data-cell--text">{{ row[field] }}</span>
          </td>
        </ng-container>
      </ng-container>
    </ng-container>
    <ng-container cdkColumnDef="mobileColumns">
      <td
        class="mobile-cell"
        cdk-cell
        *cdkCellDef="let row"
        [attr.colspan]="fields.length"
      >
        <div class="mobile-grid" gdColumns="1fr 3fr">
          <ng-container
            class="mobile-field--title"
            *ngFor="let field of fields"
          >
            <span class="mobile-field--title"
              ><b>{{ field }}</b></span
            >
            <span class="mobile-field--content">{{ row[field] }}</span>
          </ng-container>
        </div>
      </td>
    </ng-container>
    <ng-container cdkColumnDef="expandedDetail">
      <td cdk-cell *cdkCellDef="let row" [attr.colspan]="fields.length">
        <div
          *ngIf="row == expandedElement"
          class="expand-panel"
          [@detailExpand]="row == expandedElement ? 'expanded' : 'collapsed'"
        >
          <div @slideDown>
            <div class="expansion-grid-parent">
              <div class="span-12 grid-term">
                <b>Term: </b>{{ row["SearchTerm"] }}
              </div>
              <div class="span-12">
                <strong class="grid-title">{{ row["Item"] }}</strong>
              </div>
              <div class="span-12">
                <mat-chip-list>
                  <mat-chip class="mat-standard-chip">
                    {{ row["ItemType"] | titlecase }}</mat-chip
                  >
                </mat-chip-list>
              </div>
              <div *ngIf="row['Inclusion']" class="span-6">
                <div
                  fxLayoutAlign="start start"
                  fxLayout="row"
                  fxLayoutGap="0.5em"
                >
                  <mat-icon
                    svgIcon="unfold_less"
                    color="accent"
                    inline="true"
                    class="mat-icon-24"
                  ></mat-icon
                  ><span class="expanded-grid-text"
                    ><h3 class="grid-header">Guidance Includes</h3>
                    {{ row["Inclusion"] }}</span
                  >
                </div>
              </div>
              <div
                *ngIf="row['Exclusion']"
                fxLayoutAlign="start start"
                class="span-6"
              >
                <div fxLayout="row" fxLayoutGap="0.5em">
                  <mat-icon
                    svgIcon="unfold_more"
                    color="accent"
                    inline="true"
                    class="mat-icon-24"
                  ></mat-icon
                  ><span class="expanded-grid-text"
                    ><h3 class="grid-header">Guidance Excludes</h3>
                    {{ row["Exclusion"] }}</span
                  >
                </div>
              </div>
              <div *ngIf="row['DiseaseState']" class="span-6">
                <div
                  fxLayout="row"
                  fxLayoutAlign="start start"
                  fxLayoutGap="5px"
                >
                  <mat-icon
                    svgIcon="error"
                    color="accent"
                    aria-label="caution using drug in disease state "
                    inline="true"
                    class="mat-icon-24"
                  ></mat-icon>
                  <span class="expanded-grid-text"
                    ><h3 class="grid-header">Caution In</h3>
                    {{ row["DiseaseState"] | caseSplit }}</span
                  >
                </div>
              </div>
              <div
                *ngIf="row['MaximumClearance'] || row['MinimumClearance']"
                class="span-6"
              >
                <b>{{ row["Recommendation"] }}</b> with clearance
                <i><b>below</b></i>
                {{ row["MaximumClearance"] }} and
                <i><b>above</b></i>
                {{ row["MinimumClearance"] }}
              </div>
              <div class="span-12">
                <div class="rationale">
                  <div
                    fxLayout="column"
                    fxLayoutAlign="start space-between"
                    class="rationale-panel"
                  >
                    <div
                      fxLayout="row"
                      fxLayoutAlign="space-between center"
                      class="'rationale-header'"
                      (click)="expandRationale()"
                      matRipple
                      matRippleColor="rgb(44, 60, 201,0.1)"
                    >
                      <span class="rationale-title">Rationale</span>
                      <button #openButton mat-icon-button>
                        <mat-icon
                          class="mat-icon-16"
                          inline="true"
                          #icon
                          [@expandButton]="'default'"
                          [svgIcon]="'add_circle_outline'"
                        ></mat-icon>
                      </button>
                    </div>

                    <div
                      fxLayout="row"
                      fxLayoutAlign="space-between center"
                      @translateRationale
                      class="rationale-content"
                    >
                      <p>{{ row["Rationale"] }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </td>
    </ng-container>

    <tr cdk-header-row class="header-row" *cdkHeaderRowDef="fields"></tr>
    <tr
      cdk-row
      *cdkRowDef="let row; columns: fields"
      class="desktop"
      (click)="expandedElement = expandedElement === row ? null : row"
    ></tr>
    <tr
      cdk-row
      *cdkRowDef="let row; columns: ['mobileColumns']"
      class="mobile"
      (click)="expandedElement = expandedElement === row ? null : row"
    ></tr>
    <tr
      cdk-row
      *cdkRowDef="let row; columns: ['expandedDetail']"
      class="example-detail-row"
    ></tr>
  </table>
</div>

<!--ngx-datatable: Master Table class
fixed-header: The header is fixed on the table
datatable-header: Header row class
datatable-header-cell: Header cell class
resizeable: Cell resizeable class
sortable: Cell drag/drop sortable class
longpress: Cell long-press activated
dragging: Cell dragging activated
sort-active: Sort active on column
sort-asc: Sort active on column with ascending applied
sort-desc: Sort active on column with descending applied
datatable-header-cell-label: Header cell text label
draggable: Header cell draggable class
datatable-body-row: Body row class
datatable-row-even: Odd row class
datatable-row-odd: Even row class
datatable-body-cell: Body cell class
sort-active: Sort active on column
sort-asc: Sort active on column with ascending applied
sort-desc: Sort active on column with descending applied-->
<!--<mat-expansion-panel
  aria-label="expand this panel to see drugs that match your search"
  class="table-expansion-panel"
  matExpansionPanelContent
  [expanded]="false"
>
  <mat-expansion-panel-header class="accordion-header">{{
    tableName | caseSplit
  }}</mat-expansion-panel-header>
  <div>
    <app-column-selector
      *ngIf="tableName"
      (columnUpdates)="changeActiveColumns($event)"
      [tableName]="tableName"
      (loaded)="selectorInitiated = true"
    ></app-column-selector>
    <div *ngIf="tableName === 'GeneralInfo'">
      This table is meant to display all drugs that flag, no matter the reason.
      More specific sorting can be found in other tables
      <br />
    </div>
    <div class="p-table-background">
      <p-table
        #dataDisplay
        [columns]="columnOptions"
        [value]="rows"
        dataKey="EntryID"
        [responsive]="true"
      >
        <ng-template pTemplate="emptymessage" let-columns>
          <tr>
            <td [attr.colspan]="columns.length">No records found</td>
          </tr>
        </ng-template>
        <ng-template #dataDisplay pTemplate="header" let-columns>
          <tr class="ptable-empty-header">
            <th class="ptable-chevron-header" style="width: 3em"></th>
            <th
              class="ptable-header-cell ptable-header-cell--padding"
              *ngFor="let col of columns"
              [pSortableColumn]="col.field"
            >
              {{ col.header | caseSplit }}
            </th>
          </tr>
        </ng-template>
        <ng-template
          pTemplate="body"
          let-element
          let-expanded="expanded"
          let-columns="columns"
        >
          <tr
            [class]="
              expanded
                ? 'ptable-body ptable-body--row'
                : 'ptable-body--row ptable-body'
            "
          >
            <td class="ptable-body-chevron-cell">
              <a [pRowToggler]="element">
                <mat-icon
                  [svgIcon]="expanded ? 'expand_less' : 'chevron_right'"
                ></mat-icon>
              </a>
            </td>
            <td
              [pRowToggler]="element"
              class="ptable-data-cell ptable-data-cell--padding"
              *ngFor="let col of columns"
            >
              <span class="show-when-small ui-column-title"
                ><b>{{ col.header }}</b></span
              >
              {{ element[col.field] | toString | titlecase }}
            </td>
          </tr>
        </ng-template>
        <ng-template
          pTemplate="rowexpansion"
          let-element
          let-columns="columns"
          let-i="rowIndex"
        >
          <tr class="ptable-expand-row">
            <td [attr.colspan]="columns.length + 1" class="ptable-expand-body">
              <br />
              <div class="padding" @slideDown>
                <div class="p-grid grid-height">
                  <div class="p-col-12 grid-term">
                    <b>Term: </b>{{ element["SearchTerm"] }}
                  </div>
                  <div class="p-col-12">
                    <strong class="grid-title">{{ element["Item"] }}</strong>
                  </div>
                  <div class="p-col-12">
                    <mat-chip-list>
                      <mat-chip class="mat-standard-chip">
                        {{ element["ItemType"] | titlecase }}</mat-chip
                      >
                    </mat-chip-list>
                  </div>
                  <div *ngIf="element['Inclusion']" class="p-col p-sm-6">
                    <div
                      fxLayoutAlign="start start"
                      fxLayout="row"
                      fxLayoutGap="0.5em"
                    >
                      <mat-icon
                        svgIcon="unfold_less"
                        color="accent"
                        inline="true"
                        class="mat-icon-24"
                      ></mat-icon
                      ><span class="expanded-grid-text"
                        ><h3 class="grid-header">Guidance Includes</h3>
                        {{ element["Inclusion"] }}</span
                      >
                    </div>
                  </div>
                  <div
                    *ngIf="element['Exclusion']"
                    fxLayoutAlign="start start"
                    class="p-col p-sm-6"
                  >
                    <div fxLayout="row" fxLayoutGap="0.5em">
                      <mat-icon
                        svgIcon="unfold_more"
                        color="accent"
                        inline="true"
                        class="mat-icon-24"
                      ></mat-icon
                      ><span class="expanded-grid-text"
                        ><h3 class="grid-header">Guidance Excludes</h3>
                        {{ element["Exclusion"] }}</span
                      >
                    </div>
                  </div>
                  <div *ngIf="element['DiseaseState']" class="p-col p-sm-6">
                    <div
                      fxLayout="row"
                      fxLayoutAlign="start start"
                      fxLayoutGap="5px"
                    >
                      <mat-icon
                        svgIcon="error"
                        color="accent"
                        aria-label="caution using drug in disease state "
                        inline="true"
                        class="mat-icon-24"
                      ></mat-icon>
                      <span class="expanded-grid-text"
                        ><h3 class="grid-header">Caution In</h3>
                        {{ element["DiseaseState"] | caseSplit }}</span
                      >
                    </div>
                  </div>
                  <div
                    *ngIf="
                      element['MaximumClearance'] || element['MinimumClearance']
                    "
                    class="p-col p-sm-6"
                  >
                    <b>{{ element["Recommendation"] }}</b> with clearance
                    <i><b>below</b></i>
                    {{ element["MaximumClearance"] }} and
                    <i><b>above</b></i>
                    {{ element["MinimumClearance"] }}
                  </div>
                  <div class="p-col-12">
                    <div class="rationale">
                      <div
                        fxLayout="column"
                        fxLayoutAlign="start space-between"
                        class="rationale-panel"
                      >
                        <div
                          fxLayout="row"
                          fxLayoutAlign="space-between center"
                          [class]="
                            rationale[i].expanded
                              ? 'rationale-header'
                              : 'rationale-header collapse'
                          "
                          (click)="expandRationale(i)"
                          matRipple
                          matRippleColor="rgb(44, 60, 201,0.1)"
                        >
                          <span class="rationale-title">Rationale</span>
                          <button #openButton mat-icon-button>
                            <mat-icon
                              class="mat-icon-16"
                              inline="true"
                              #icon
                              [@expandButton]="
                                rationale[i].expanded ? 'default' : 'rotated'
                              "
                              [svgIcon]="
                                rationale[i].expanded
                                  ? 'remove_circle_outline'
                                  : 'add_circle_outline'
                              "
                            ></mat-icon>
                          </button>
                        </div>

                        <div
                          fxLayout="row"
                          fxLayoutAlign="space-between center"
                          @translateRationale
                          class="rationale-content"
                          *ngIf="rationale[i].expanded"
                        >
                          <p>{{ element["Rationale"] }}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <br />
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <br />
</mat-expansion-panel>
-->
